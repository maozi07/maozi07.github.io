<!DOCTYPE HTML>

<html>
    
	<head>
		<title>Louguan Star's Blog</title>
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="baidu-site-verification" content="TXUGY4f1Fu" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="/js/jquery.min.js"></script>
		<script src="/js/jquery.scrollzer.min.js"></script>
		<script src="/js/jquery.scrolly.min.js"></script>
		<script src="/js/skel.min.js"></script>
		<script src="/js/skel-layers.min.js"></script>
		<script src="/js/init.js"></script>
		<noscript>
			<link rel="stylesheet" href="/css/skel.css" />
			<link rel="stylesheet" href="/css/style.css" />
			<link rel="stylesheet" href="/css/style-xlarge.css" />
		</noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
	</head>

    <body>
        <div id="wrapper">
        <!-- Header -->
    <section id="header" class="skel-layers-fixed">
        <header>
            <span class="image avatar"><img src="/images/avatar.jpg" alt="" /></span>
            <h1 id="logo"><a href="/">Louguan Star</a></h1>
            <p>心之安处，便是吾乡...</p>
        </header>
        <nav id="nav">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="/about">About</a></li>
            </ul>
        </nav>
        <footer>
            <ul class="icons">
                <!-- <li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li> -->
                <!-- <li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li> -->
                <!-- <li><a href="#" class="icon fa-instagram"><span class="label">Instagram</span></a></li> -->
                <li><a href="https://github.com/maozi07" class="icon fa-github"><span class="label">Github</span></a></li>
                <li><a href="#" class="icon fa-envelope"><span class="label">Email</span></a></li>
            </ul>
        </footer>
    </section>


            <!-- Main -->
            <div id="main">
                <section>
    <div class="container">
        <header class="major">
            <h2>Awk使用nr与fnr合并两个文件</h2>
                <p class="post-meta">Jun 21, 2016</p>
        </header>

        <section class="post-content">
            <h3 id="awknrfnr">使用awk的NR与FNR合并两个文件</h3>
<p>工作遇到一个需求有如下两个文件：</p>

<ul>
  <li>file a</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>store.louguanstar.com	5.6.7.8
app.louguanstar.com	1.2.3.4
foo.louguanstar.com	a.b.c.d
</code></pre>
</div>

<ul>
  <li>file b</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>foo.louguanstar.com	1300
store.louguanstar.com	1100
app.louguanstar.com	1200
</code></pre>
</div>

<p>现在需要把这个文件处理为如下样式然后加上xml文件头就行，用作hadoop集群的topology文件</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;node name="foo.louguanstar.com" rack="/avatar/1300"/&gt;
&lt;node name="a.b.c.d" rack="/avatar/1300"/&gt;
&lt;node name="store.louguanstar.com" rack="/avatar/1100"/&gt;
&lt;node name="5.6.7.8" rack="/avatar/1100"/&gt;
&lt;node name="app.louguanstar.com" rack="/avatar/1200"/&gt;
&lt;node name="1.2.3.4" rack="/avatar/1200"/&gt;
</code></pre>
</div>

<p>awk可以使用自身变量NR和FNR来处理多个文件。</p>

<p>NR：awk开始执行程序后所读取的数据行数。</p>

<p>FNR：awk当前读取的记录数，FNR值小于等于NR（当awk读取第二个文件时，FNR是从0开始重新计数，而NR继续累加）。</p>

<p>NR==FNR：用于在读取两个或两个以上的文件时，判断是不是在读取第一个文件。</p>

<p>awk处理多个文件的基本语法是:
awk -F分隔符 ‘BEGIN { 初始化 } { 循环执行部分 } END { 结束处理 }’ file1 file2</p>

<p>其中BEGIN和END可以省略，-F用来指定分割符</p>

<p>最后使用如下命令就可以得到上面的结果：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>awk 'NR==FNR{a[$1]=$2}FNR&lt;NR{print $1,a[$1],$2}' a b | awk '{print "&lt;node name=\""$1"\" rack=\"/avatar/"$3"\"/&gt;\n&lt;node name=\""$2"\" rack=\"/avatar/"$3"\"/&gt;"}'
</code></pre>
</div>

<p>后面又发现使用awk可以统计每块网卡的网速，命令如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>tmp1=`mktemp`
tmp2=`mktemp`
/bin/cat /proc/net/dev | awk 'NR&gt;2 {print $1" tx "$2" ,rx "$10}' |sed 's/://' &gt;$tmp1
sleep 5
/bin/cat /proc/net/dev | awk 'NR&gt;2 {print $1" tx "$2" ,rx "$10}' |sed 's/://' &gt;$tmp2

echo ",
    \"band_width_out\":{"
awk 'NR==FNR{a[$1]=$3}NR&gt;FNR{print "        \""$1"\":\""($3-a[$1])/5/1024"MB/s\","}' $tmp1 $tmp2

echo "    },
    \"band_width_in\":{"
awk 'NR==FNR{a[$1]=$NF}NR&gt;FNR{print "        \""$1"\":\"" ($NF-a[$1])/5/1024"MB/s\","}' $tmp1 $tmp2
echo "    }"
rm $tmp1 $tmp2
</code></pre>
</div>

<h3 id="section">参考文档</h3>

<blockquote>
  <ol>
    <li><a href="http://blog.csdn.net/imzoer/article/details/8734474">http://blog.csdn.net/imzoer/article/details/8734474</a></li>
  </ol>
</blockquote>

        </section>

        <footer>
            
            <a href="/2016/06/06/yarn%E9%85%8D%E7%BD%AEkerberos%E9%9C%80%E8%A6%81%E5%9C%A8%E6%89%80%E6%9C%89nodemanager%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7.html" class="float-left">&larr; Previous</a> 
            
            <a href="/2016/07/19/%E5%85%B3%E4%BA%8Eyum%E7%9A%84%E5%8F%98%E9%87%8F.html" class="float-right">Next &rarr;</a> 

        </footer>

        <div id="footer" class="copyright">
            <ul class="copyright">
                <li>本文系原创，转载请注明：转自<a target="_blank" href="http://www.louguanstar.com">LouguanStar's Blog</a>，作者：<a target="_blank" href="http://wwww.louguanstar.com/about/">LouguanStar</a></li>
                <li>除特别说明外，本文基于<a target="_blank" href="http://creativecommons.org/licenses/by-sa/3.0/cn/">知识共享署名-相同方式共享 3.0 中国大陆许可协议</a>发布，转载或其它引用请保留文本署名和文章链接。</li>
            </ul>
        </div>

    </div>

</section>


            </div>
            <!-- Footer -->
    <section id="footer">
        <div class="container">
            <ul class="copyright">
                <li>&copy;2016&nbsp;Louguan Star. &nbsp;All rights reserved.&nbsp;Powered by jekyll.</li>
            </ul>
        </div>
    </section>

		</div>
	</body>
</html>
