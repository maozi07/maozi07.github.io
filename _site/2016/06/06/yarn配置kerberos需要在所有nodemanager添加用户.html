<!DOCTYPE HTML>

<html>
    
	<head>
		<title>Louguan Star's Blog</title>
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="baidu-site-verification" content="TXUGY4f1Fu" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="/js/jquery.min.js"></script>
		<script src="/js/jquery.scrollzer.min.js"></script>
		<script src="/js/jquery.scrolly.min.js"></script>
		<script src="/js/skel.min.js"></script>
		<script src="/js/skel-layers.min.js"></script>
		<script src="/js/init.js"></script>
		<noscript>
			<link rel="stylesheet" href="/css/skel.css" />
			<link rel="stylesheet" href="/css/style.css" />
			<link rel="stylesheet" href="/css/style-xlarge.css" />
		</noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
	</head>

    <body>
        <div id="wrapper">
        <!-- Header -->
    <section id="header" class="skel-layers-fixed">
        <header>
            <span class="image avatar"><img src="/images/avatar.jpg" alt="" /></span>
            <h1 id="logo"><a href="/">Louguan Star</a></h1>
            <p>心之安处，便是吾乡...</p>
        </header>
        <nav id="nav">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="/about">About</a></li>
            </ul>
        </nav>
        <footer>
            <ul class="icons">
                <!-- <li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li> -->
                <!-- <li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li> -->
                <!-- <li><a href="#" class="icon fa-instagram"><span class="label">Instagram</span></a></li> -->
                <li><a href="https://github.com/maozi07" class="icon fa-github"><span class="label">Github</span></a></li>
                <li><a href="#" class="icon fa-envelope"><span class="label">Email</span></a></li>
            </ul>
        </footer>
    </section>


            <!-- Main -->
            <div id="main">
                <section>
    <div class="container">
        <header class="major">
            <h2>Yarn配置kerberos需要在所有nodemanager添加用户</h2>
                <p class="post-meta">Jun 6, 2016</p>
        </header>

        <section class="post-content">
            <p>yarn添加kerberos认证需要在所有nodemanager上添加kerberos principal用户</p>

<h3 id="section">发现问题</h3>

<p>同事反应yarn提交任务有问题，发现yarn配置了kerberos认证，于是给新建的用户添加了principal，并且生成了keytab</p>

<div class="highlighter-rouge"><pre class="highlight"><code>添加principal
kadmin.local -q "addprinc -randkey spark_deploy@LOUGUANSTAR.COM"
生成keytab
kadmin.local -q "ktadd -k spark_deploy.keytab spark_deploy@LOUGUANSTAR.COM"

其他kerberos操作：
删除principal
kadmin.local -q "delprinc spark_deploy@LOUGUANSTAR.COM"
查看所有principal
./kadmin.local -q "listprincs" | grep spark
</code></pre>
</div>

<p>然后进行kerberos认证，尝试提交任务</p>

<div class="highlighter-rouge"><pre class="highlight"><code>kinit -kt spark_deploy.keytab spark_deploy
hadoop jar  /usr/lib/hadoop-mapreduce/hadoop-mapreduce-examples-2.6.0-cdh5.5.2.jar pi 10 100
</code></pre>
</div>
<p>任务很快结束，jobhistory中找不到日志，resourcemanager中的报错信息很简短，错误信息大致如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>main : run as user is spark_deploy
main : requested yarn user is spark_deploy
User spark_deploy not found
</code></pre>
</div>
<p>### 解决问题</p>

<p>始终觉得问题在设置yarn.nodemanager.linux-container-executor的问题上，如果没有设置kerberos认证那么可以指定运行yarn.nodemanager.linux-container-executor；配置了kerberos之后yarn任务的用户为kerberos principal中的用户如：spark_deploy@LOUGUANSTAR.COM中即为spark_deploy
经历了多半天各种调试，最后发现：<code class="highlighter-rouge">配置kerberos之后必须在每个nodemanager上新建kerberos principal中的用户</code>，这样才能确保每个任务都可以在nodemanager上运行</p>

<p>在所有nodemanager上添加spark_deploy用户，问题成功解决</p>

<h3 id="section-1">参考文档</h3>

<blockquote>
  <ol>
    <li><a href="https://community.cloudera.com/t5/Batch-Processing-and-Workflow/YARN-force-nobody-user-on-all-jobs-and-so-they-fail/td-p/26050">https://community.cloudera.com/t5/Batch-Processing-and-Workflow/YARN-force-nobody-user-on-all-jobs-and-so-they-fail/td-p/26050</a></li>
  </ol>
</blockquote>

        </section>

        <footer>
            
            <a href="/2016/05/31/Linux%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4.html" class="float-left">&larr; Previous</a> 
            

        </footer>

        <div id="footer" class="copyright">
            <ul class="copyright">
                <li>本文系原创，转载请注明：转自<a target="_blank" href="http://www.louguanstar.com">LouguanStar's Blog</a>，作者：<a target="_blank" href="http://wwww.louguanstar.com/about/">LouguanStar</a></li>
                <li>除特别说明外，本文基于<a target="_blank" href="http://creativecommons.org/licenses/by-sa/3.0/cn/">知识共享署名-相同方式共享 3.0 中国大陆许可协议</a>发布，转载或其它引用请保留文本署名和文章链接。</li>
            </ul>
            <!-- 多说评论框 start -->
                <div class="ds-thread" data-thread-key="/2016/06/06/yarn配置kerberos需要在所有nodemanager添加用户" data-title="Yarn配置kerberos需要在所有nodemanager添加用户" data-url="http://louguanstar.com//2016/06/06/yarn%E9%85%8D%E7%BD%AEkerberos%E9%9C%80%E8%A6%81%E5%9C%A8%E6%89%80%E6%9C%89nodemanager%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7.html"></div>
            <!-- 多说评论框 end -->
            <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
            <script type="text/javascript">
            var duoshuoQuery = {short_name:"louguanstar"};
                (function() {
                    var ds = document.createElement('script');
                    ds.type = 'text/javascript';ds.async = true;
                    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                    ds.charset = 'UTF-8';
                    (document.getElementsByTagName('head')[0]
                     || document.getElementsByTagName('body')[0]).appendChild(ds);
                })();
            </script>
            <!-- 多说公共JS代码 end -->
        </div>

    </div>

</section>


            </div>
            <!-- Footer -->
    <section id="footer">
        <div class="container">
            <ul class="copyright">
                <li>&copy;2016&nbsp;Louguan Star. &nbsp;All rights reserved.&nbsp;Powered by jekyll.</li>
            </ul>
        </div>
    </section>

		</div>
	</body>
</html>
